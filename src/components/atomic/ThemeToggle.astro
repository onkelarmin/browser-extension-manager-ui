---
// Asset imports
import IconLight from "@assets/icon-moon.svg";
import IconDark from "@assets/icon-sun.svg";

// Types
import type { HTMLAttributes } from "astro/types";

interface Props extends HTMLAttributes<"button"> {
  label?: string;
  classes?: string;
}

const { label = "Dark Mode", classes, ...rest } = Astro.props;
---

<button
  class:list={["theme-toggle", classes]}
  id="theme-toggle"
  aria-label={label}
  aria-pressed="false"
  {...rest}
>
  <IconLight class="icon icon-light" aria-hidden="true" />
  <IconDark class="icon icon-dark" aria-hidden="true" />
</button>

<style lang="scss">
  button {
    display: inline-flex;
    justify-content: center;
    align-items: center;
    color: var(--fg-icon-theme-idle);
    background-color: var(--bg-icon-theme-idle);
    border: none;
    cursor: pointer;
    padding: var(--pad-select-sm);
    border-radius: var(--br-sm);
    transition:
      color var(--trans-default),
      background-color var(--trans-default);

    @media (hover: hover) {
      &:hover {
        color: var(--fg-icon-theme-hover);
        background-color: var(--bg-icon-theme-hover);
      }
    }

    &:focus {
      outline: 0px solid transparent;
    }

    &:focus-visible {
      outline: var(--bw-lg) solid var(--btn-default-focus-outline);
      outline-offset: var(--bw-lg);
    }

    // Icon
    &[aria-pressed="false"] .icon-dark {
      display: none;
    }

    &[aria-pressed="true"] .icon-light {
      display: none;
    }

    > .icon {
      width: var(--size-icon-theme);
    }
  }
</style>

<script>
  // Elements
  const root = document.documentElement as HTMLElement;
  const themeToggle = document.getElementById(
    "theme-toggle"
  ) as HTMLButtonElement;

  //   Variables
  const storageKey = "theme-preference";
  let theme = root.dataset.theme as string;
  // Set ThemeToggle to initial theme
  updateThemeToggle();

  // Functions
  function setLocalStorage() {
    localStorage.setItem(storageKey, theme);
  }

  function updateThemeToggle() {
    themeToggle.setAttribute(
      "aria-pressed",
      theme === "dark" ? "true" : "false"
    );
  }

  function updateUI() {
    root.dataset.theme = theme;
    updateThemeToggle();
  }

  function handleThemeChange() {
    setLocalStorage();
    if (!document.startViewTransition) {
      updateUI();
      return;
    }

    document.startViewTransition(() => {
      updateUI();
    });
  }

  // Event-listeners
  themeToggle.addEventListener("click", () => {
    // flip current value
    theme = theme === "light" ? "dark" : "light";
    handleThemeChange();
  });

  window
    .matchMedia("(prefers-color-scheme: dark)")
    .addEventListener("change", (e) => {
      theme = e.matches ? "dark" : "light";
      handleThemeChange();
    });
</script>
